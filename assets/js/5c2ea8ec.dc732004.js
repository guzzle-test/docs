(self.webpackChunkguzzle=self.webpackChunkguzzle||[]).push([[3359],{3905:function(e,t,a){"use strict";a.d(t,{Zo:function(){return c},kt:function(){return p}});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},l=Object.keys(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)a=l[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),u=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,l=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(a),p=n,k=d["".concat(s,".").concat(p)]||d[p]||m[p]||l;return a?r.createElement(k,o(o({ref:t},c),{},{components:a})):r.createElement(k,o({ref:t},c))}));function p(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=a.length,o=new Array(l);o[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:n,o[1]=i;for(var u=2;u<l;u++)o[u]=a[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}d.displayName="MDXCreateElement"},7604:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return i},metadata:function(){return s},toc:function(){return u},default:function(){return m}});var r=a(2122),n=a(9756),l=(a(7294),a(3905)),o=["components"],i={},s={unversionedId:"How to guides/Ingest data/Watermark",id:"How to guides/Ingest data/Watermark",isDocsHomePage:!1,title:"Watermark",description:"Using Watermark for Databases",source:"@site/docs/How to guides/Ingest data/Watermark.md",sourceDirName:"How to guides/Ingest data",slug:"/How to guides/Ingest data/Watermark",permalink:"/docs/How to guides/Ingest data/Watermark",editUrl:"https://github.com/ja-guzzle/docs/blob/master/docs/How to guides/Ingest data/Watermark.md",version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Processing",permalink:"/docs/How to guides/Ingest data/Processing"},next:{title:"Working with Big Data",permalink:"/docs/How to guides/Ingest data/Working with Big Data"}},u=[{value:"How Does a Watermark Work in Guzzle",id:"how-does-a-watermark-work-in-guzzle",children:[]},{value:"Custom Watermarks or Watermark Filter",id:"custom-watermarks-or-watermark-filter",children:[]}],c={toc:u};function m(e){var t=e.components,i=(0,n.Z)(e,o);return(0,l.kt)("wrapper",(0,r.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"Using Watermark for Databases"),(0,l.kt)("p",null,"A watermark represents tracking the last loaded value for one or more columns for a given source table or source SQL to enable loading data incrementally. Using watermark columns is one of the mechanisms used for changed data capture (CDC). "),(0,l.kt)("p",null,"Ingestion activity in Guzzle provides an automated mechanism to track last loaded maximum value for the specified columns which are stored in the ",(0,l.kt)("strong",{parentName:"p"},"watermark "),"table in Guzzle repository. Ingestion activity will include additional predicate on the source table or query to to capture the values "),(0,l.kt)("p",null,"Guzzle supports Watermark for all the 5 types of Database Connectors namely: "),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Delta")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Hive")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Azure SQL")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Azure Synapse Connector")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"JDBC"))),(0,l.kt)("h2",{id:"how-does-a-watermark-work-in-guzzle"},"How Does a Watermark Work in Guzzle"),(0,l.kt)("p",null,'"Configure Watermark" section in Source Tab contains following properties for configuring  incremental loading for a source table: '),(0,l.kt)("table",null,(0,l.kt)("tr",null,(0,l.kt)("td",null,"Property "),(0,l.kt)("td",null,"Description"),(0,l.kt)("td",null,"Default Value"),(0,l.kt)("td",null,"Required")),(0,l.kt)("tr",null,(0,l.kt)("td",null,"Watermark Columns"),(0,l.kt)("td",null,"Specify one or more columns that shall be used for watermark tracking Once specified, it will track the maximum value of each of this columns based on incoming source data"),(0,l.kt)("td",null,"None"),(0,l.kt)("td",null,"Yes")),(0,l.kt)("tr",null,(0,l.kt)("td",null,"Watermark filter"),(0,l.kt)("td",null,"To specify custom watermark filter using the watermark columns When left blank Ingestion activity generates automatic filter which  is series of AND condition with column value > watermark value",(0,l.kt)("p",null,"Example:\nlast_modified_dt > '2021-06-17 04:01:46' AND id > '4'")),(0,l.kt)("td",null,"None"),(0,l.kt)("td",null,"No")),(0,l.kt)("tr",null,(0,l.kt)("td",null,"Additional identifier for tracking watermark"),(0,l.kt)("td",null,"If watermark "),(0,l.kt)("td",null,"None"),(0,l.kt)("td",null,"No"))),(0,l.kt)("p",null,"Guzzle first retrieves the old watermark value and compares it with the current watermark value. After that, it copies only the changes from the source database, based on a comparison between the two watermark values. Finally, it stores the new high-watermark value to the target table for Data loading next time."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"In the Configure Watermark Section specify the Column Name you would like to apply the Watermark to. The allowed values are Timestamps, Dates and Integers.")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"In the first job cycle Guzzle will load all the Data from the Source table into the Target table and record the maximum value of the specified column.")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Now when the next job cycle is run and Guzzle tries to read the Source Table, it will only load the Source Data which is greater than the recorded value in the previous step. ",(0,l.kt)("strong",{parentName:"p"},"(Note: Only when Load type is Incremental which is our Default choice)"),".")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"The new highest value in the Second Job Cycle will be recorded and thus the Watermark value will be updated accordingly.")),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"If the user wants to completely refresh the Data the Load Type can be changed to Full."))),(0,l.kt)("p",null,"The Working of the Watermark function can be understood through the Flow Diagram below:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"image alt text",src:a(4335).Z})),(0,l.kt)("p",null,"In the image below we consider 2 columns of our Data last_modified_dt which is a Date timestamp and id which is an integer. If we use incremental as our Load Type, in the first job Guzzle will read the entire Data and record the highest values of both columns and use them as incrementing values. If there is no change in the table before the second run then Guzzle will read 0 Parameters or Values in the second run."),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"image alt text",src:a(7970).Z})),(0,l.kt)("h2",{id:"custom-watermarks-or-watermark-filter"},"Custom Watermarks or Watermark Filter"),(0,l.kt)("p",null,"We can create Custom Watermarks by using the Watermark Filter option provided by Guzzle. The Watermark Filter section can be used to specify the condition for our Columns. Only the rows which satisfy the condition will be reflected in the Target Table."),(0,l.kt)("p",null,"An Example of using the Watermark filter is:"),(0,l.kt)("p",null,"last_modified_dt > @1 and id >cast(@2 as int)"),(0,l.kt)("p",null,"The @1 represent last max value stored in guzzle watermark table for first column"),(0,l.kt)("p",null,"The @2 represent last max value stored in guzzle watermark table for second column"),(0,l.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"The cast function is used in the second test case to ensure that Guzzle reads id as an integer and not a String, as Watermark supports only timestamps and integers."))),(0,l.kt)("p",null,"If Custom Watermark is applied to multiple columns the and condition is used as shown above."),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"image alt text",src:a(7443).Z})),(0,l.kt)("p",null,"Depending on the typecast database Guzzle passes the values as string to the underlying database for the watermark column."),(0,l.kt)("p",null,"An example of applying the Watermark technique in MySQL can also be seen in the example below:"),(0,l.kt)("p",null,"insert into customer1_src values (11,'abc','xyz','Male',40,'2021-06-17 03:52:25');  "),(0,l.kt)("p",null,"\u200b"),(0,l.kt)("p",null,"create table customer1_tgt(id int, first_name varchar(100), last_name varchar(100), gender varchar(100), age int, last_modified_dt timestamp,refresh_ts timestamp);   "),(0,l.kt)("p",null,"Here the insert into statement is used to insert a new record into our table. "),(0,l.kt)("p",null,"The second statement uses 2 watermark columns: last_modified_dt timestamp and refresh_ts timestamp."),(0,l.kt)("p",null,"Custom Watermarks can also be applied to a single column. Instead of applying a standard filter as shown above, we can apply watermarks to a single column for different purposes. "),(0,l.kt)("p",null,"In the above example we can apply the custom watermark to only the last_modified_dt column to fetch Data for let's say the last 7 days. This can be done using the statement below:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"image alt text",src:a(7474).Z})),(0,l.kt)("p",null,"The cast function will convert our max value into a Date and we then subtract 7. Whatever is the max value it will fetch Data for the last 7 days."))}m.isMDXComponent=!0},4335:function(e,t,a){"use strict";t.Z=a.p+"assets/images/watermark1-da3b7735f0ecd42d88a32752a388a00b.png"},7970:function(e,t,a){"use strict";t.Z=a.p+"assets/images/watermark2-6131fb9cc6446902b568a68c6dce37c4.png"},7443:function(e,t,a){"use strict";t.Z=a.p+"assets/images/watermark3-1e1c37679d4610e86b1d4434a998626f.png"},7474:function(e,t,a){"use strict";t.Z=a.p+"assets/images/watermark4-9380243fa3cf6f11772af663eeb1a4f1.png"}}]);